import { ContentChildren, Directive, ElementRef, Optional, Renderer2, Self } from '@angular/core';
import { SinDirective } from './sin.directive';
import { ControlContainer, FormControlName } from '@angular/forms';
import * as rx from 'rxjs';
import * as rxop from 'rxjs/operators';
export function findAdded([olders, newers]) {
    return newers.filter(newer => olders.indexOf(newer) == -1);
}
export function findRemoved([olders, newers]) {
    return findAdded([newers, olders]);
}
export class FormWithSinsDirective {
    constructor(controlContainer, renderer, elementRef) {
        this.controlContainer = controlContainer;
        this.renderer = renderer;
        this.elementRef = elementRef;
        this.destroy$ = new rx.Subject();
        this.classNameForInvalidControl = 'ngx-sin-invalid';
    }
    markValidityFor(control, addClass) {
        const index = this.formControlNames.toArray()
            .findIndex(formControlName => {
            return control == formControlName.control;
        });
        let elRef;
        if (index == -1) {
            const formGroup = this.controlContainer.control;
            if (formGroup == control) {
                elRef = this.elementRef;
            }
            else {
                // Could not find the FormControl in the view, do nothing
                return;
            }
        }
        else {
            elRef = this.formControlElRefs.toArray()[index];
        }
        if (addClass) {
            this.renderer.addClass(elRef.nativeElement, this.classNameForInvalidControl);
        }
        else {
            this.renderer.removeClass(elRef.nativeElement, this.classNameForInvalidControl);
        }
    }
    markValidityForAll(controls, addClass) {
        controls.forEach(control => this.markValidityFor(control, addClass));
    }
    markAllAsValid() {
        this.formControlElRefs.forEach(elRef => {
            this.renderer.removeClass(elRef.nativeElement, this.classNameForInvalidControl);
        });
    }
    ngAfterContentInit() {
        if (this.sinDirectives == null) {
            // This form does not have any sins
            return;
        }
        this.formControls = rx.zip(this.formControlNames.changes.pipe(rxop.startWith(this.formControlNames)), this.formControlElRefs.changes.pipe(rxop.startWith(this.formControlElRefs))).pipe(rxop.map(([name, elRef]) => ({ name, elRef })));
        const visibleSins$ = this.sinDirectives.changes.pipe(rxop.startWith(this.sinDirectives), rxop.map((list) => list.toArray()), rxop.switchMap((sins) => rx.combineLatest(sins.map(sin => sin.visible$))), rxop.map((controls) => controls.filter(control => control != null)));
        this.formControls.pipe(rxop.withLatestFrom(this.sinDirectives.changes.pipe(rxop.startWith(this.sinDirectives)), (fc, s) => s), rxop.map((list) => list.toArray().map(sin => sin.visible$.getValue())), rxop.map((controls) => controls.filter(control => control != null)), rxop.withLatestFrom(visibleSins$, (_, sins) => sins))
            .subscribe((controls) => {
            // When form controls on the page change, we grab the last info about
            // visible sins and use that. We have to be destructive here
            this.markAllAsValid();
            this.markValidityForAll(controls, true);
        });
        visibleSins$.pipe(rxop.pairwise())
            .subscribe(([oldControls, newControls]) => {
            // We can calculate diff instead of removing and setting everything.
            const added = findAdded([oldControls, newControls]);
            const removed = findRemoved([oldControls, newControls]);
            this.markValidityForAll(added, true);
            this.markValidityForAll(removed, false);
        });
    }
    ngOnDestroy() {
        this.destroy$.next();
    }
}
FormWithSinsDirective.decorators = [
    { type: Directive, args: [{ selector: 'form' },] }
];
FormWithSinsDirective.ctorParameters = () => [
    { type: ControlContainer, decorators: [{ type: Optional }, { type: Self }] },
    { type: Renderer2 },
    { type: ElementRef }
];
FormWithSinsDirective.propDecorators = {
    sinDirectives: [{ type: ContentChildren, args: [SinDirective, { descendants: true },] }],
    formControlNames: [{ type: ContentChildren, args: [FormControlName, { descendants: true },] }],
    formControlElRefs: [{ type: ContentChildren, args: [FormControlName, { descendants: true, read: ElementRef },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS13aXRoLXNpbnMuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9mb3JtLXdpdGgtc2lucy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFtQixlQUFlLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBYSxRQUFRLEVBQWEsU0FBUyxFQUFFLElBQUksRUFBQyxNQUFNLGVBQWUsQ0FBQTtBQUN2SSxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0saUJBQWlCLENBQUE7QUFDNUMsT0FBTyxFQUFrQixnQkFBZ0IsRUFBRSxlQUFlLEVBQVksTUFBTSxnQkFBZ0IsQ0FBQTtBQUM1RixPQUFPLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQTtBQUMxQixPQUFPLEtBQUssSUFBSSxNQUFNLGdCQUFnQixDQUFBO0FBSXRDLE1BQU0sVUFBVSxTQUFTLENBQUssQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFZO0lBQ3ZELE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUM1RCxDQUFDO0FBRUQsTUFBTSxVQUFVLFdBQVcsQ0FBSyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQVk7SUFDekQsT0FBTyxTQUFTLENBQUMsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQTtBQUNwQyxDQUFDO0FBR0QsTUFBTSxPQUFPLHFCQUFxQjtJQWlCaEMsWUFBeUMsZ0JBQWtDLEVBQ3RELFFBQW1CLEVBQ25CLFVBQXNCO1FBRkYscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUN0RCxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ25CLGVBQVUsR0FBVixVQUFVLENBQVk7UUFObkMsYUFBUSxHQUFHLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBRTNCLCtC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O2FBQy9CLFNBQVMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBMEIsRUFBRSxFQUFFO1lBQ2pFLG9FQUFvRTtZQUNwRSxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQTtZQUNuRCxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQTtZQUN2RCxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFBO1lBQ3BDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDekMsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0lBRU0sV0FBVztRQUNoQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFBO0lBQ3RCLENBQUM7OztZQTFHRixTQUFTLFNBQUMsRUFBQyxRQUFRLEVBQUUsTUFBTSxFQUFDOzs7WUFkSixnQkFBZ0IsdUJBZ0N6QixRQUFRLFlBQUksSUFBSTtZQWxDa0UsU0FBUztZQUFyRCxVQUFVOzs7NEJBbUI3RCxlQUFlLFNBQUMsWUFBWSxFQUFFLEVBQUMsV0FBVyxFQUFFLElBQUksRUFBQzsrQkFHakQsZUFBZSxTQUFDLGVBQWUsRUFBRSxFQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUM7Z0NBR3BELGVBQWUsU0FBQyxlQUFlLEVBQUUsRUFBQyxXQUFXLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0FmdGVyQ29udGVudEluaXQsIENvbnRlbnRDaGlsZHJlbiwgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBPbkRlc3Ryb3ksIE9wdGlvbmFsLCBRdWVyeUxpc3QsIFJlbmRlcmVyMiwgU2VsZn0gZnJvbSAnQGFuZ3VsYXIvY29yZSdcbmltcG9ydCB7U2luRGlyZWN0aXZlfSBmcm9tICcuL3Npbi5kaXJlY3RpdmUnXG5pbXBvcnQge0Fic3RyYWN0Q29udHJvbCwgQ29udHJvbENvbnRhaW5lciwgRm9ybUNvbnRyb2xOYW1lLCBGb3JtR3JvdXB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJ1xuaW1wb3J0ICogYXMgcnggZnJvbSAncnhqcydcbmltcG9ydCAqIGFzIHJ4b3AgZnJvbSAncnhqcy9vcGVyYXRvcnMnXG5cbmV4cG9ydCB0eXBlIFBhaXI8VD4gPSBbVCwgVF1cblxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRBZGRlZDxUPiAoW29sZGVycywgbmV3ZXJzXTogUGFpcjxUW10+KTogVFtdIHtcbiAgcmV0dXJuIG5ld2Vycy5maWx0ZXIobmV3ZXIgPT4gb2xkZXJzLmluZGV4T2YobmV3ZXIpID09IC0xKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZFJlbW92ZWQ8VD4gKFtvbGRlcnMsIG5ld2Vyc106IFBhaXI8VFtdPik6IFRbXSB7XG4gIHJldHVybiBmaW5kQWRkZWQoW25ld2Vycywgb2xkZXJzXSlcbn1cblxuQERpcmVjdGl2ZSh7c2VsZWN0b3I6ICdmb3JtJ30pXG5leHBvcnQgY2xhc3MgRm9ybVdpdGhTaW5zRGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCwgT25EZXN0cm95IHtcblxuICBAQ29udGVudENoaWxkcmVuKFNpbkRpcmVjdGl2ZSwge2Rlc2NlbmRhbnRzOiB0cnVlfSlcbiAgcHVibGljIHNpbkRpcmVjdGl2ZXM6IFF1ZXJ5TGlzdDxTaW5EaXJlY3RpdmU+XG5cbiAgQENvbnRlbnRDaGlsZHJlbihGb3JtQ29udHJvbE5hbWUsIHtkZXNjZW5kYW50czogdHJ1ZX0pXG4gIHB1YmxpYyBmb3JtQ29udHJvbE5hbWVzOiBRdWVyeUxpc3Q8Rm9ybUNvbnRyb2xOYW1lPlxuXG4gIEBDb250ZW50Q2hpbGRyZW4oRm9ybUNvbnRyb2xOYW1lLCB7ZGVzY2VuZGFudHM6IHRydWUsIHJlYWQ6IEVsZW1lbnRSZWZ9KVxuICBwdWJsaWMgZm9ybUNvbnRyb2xFbFJlZnM6IFF1ZXJ5TGlzdDxFbGVtZW50UmVmPlxuXG4gIHByaXZhdGUgZm9ybUNvbnRyb2xzOiByeC5PYnNlcnZhYmxlPHsgbmFtZTogRm9ybUNvbnRyb2xOYW1lLCBlbFJlZjogRWxlbWVudFJlZiB9PlxuXG4gIHByaXZhdGUgZGVzdHJveSQgPSBuZXcgcnguU3ViamVjdCgpXG5cbiAgcHJpdmF0ZSBjbGFzc05hbWVGb3JJbnZhbGlkQ29udHJvbCA9ICduZ3gtc2luLWludmFsaWQnXG5cbiAgY29uc3RydWN0b3IgKEBPcHRpb25hbCgpIEBTZWxmKCkgcHJpdmF0ZSBjb250cm9sQ29udGFpbmVyOiBDb250cm9sQ29udGFpbmVyLFxuICAgICAgICAgICAgICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgICAgICAgICAgICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7XG4gIH1cblxuICBwcml2YXRlIG1hcmtWYWxpZGl0eUZvciAoY29udHJvbDogQWJzdHJhY3RDb250cm9sLCBhZGRDbGFzczogYm9vbGVhbik6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5mb3JtQ29udHJvbE5hbWVzLnRvQXJyYXkoKVxuICAgICAgLmZpbmRJbmRleChmb3JtQ29udHJvbE5hbWUgPT4ge1xuICAgICAgICByZXR1cm4gY29udHJvbCA9PSBmb3JtQ29udHJvbE5hbWUuY29udHJvbFxuICAgICAgfSlcblxuICAgIGxldCBlbFJlZjogRWxlbWVudFJlZlxuXG4gICAgaWYgKGluZGV4ID09IC0xKSB7XG4gICAgICBjb25zdCBmb3JtR3JvdXAgPSB0aGlzLmNvbnRyb2xDb250YWluZXIuY29udHJvbCBhcyBGb3JtR3JvdXBcbiAgICAgIGlmIChmb3JtR3JvdXAgPT0gY29udHJvbCkge1xuICAgICAgICBlbFJlZiA9IHRoaXMuZWxlbWVudFJlZlxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gQ291bGQgbm90IGZpbmQgdGhlIEZvcm1Db250cm9sIGluIHRoZSB2aWV3LCBkbyBub3RoaW5nXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBlbFJlZiA9IHRoaXMuZm9ybUNvbnRyb2xFbFJlZnMudG9BcnJheSgpW2luZGV4XVxuICAgIH1cblxuICAgIGlmIChhZGRDbGFzcykge1xuICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyhlbFJlZi5uYXRpdmVFbGVtZW50LCB0aGlzLmNsYXNzTmFtZUZvckludmFsaWRDb250cm9sKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKGVsUmVmLm5hdGl2ZUVsZW1lbnQsIHRoaXMuY2xhc3NOYW1lRm9ySW52YWxpZENvbnRyb2wpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBtYXJrVmFsaWRpdHlGb3JBbGwgKGNvbnRyb2xzOiBBYnN0cmFjdENvbnRyb2xbXSwgYWRkQ2xhc3M6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBjb250cm9scy5mb3JFYWNoKGNvbnRyb2wgPT4gdGhpcy5tYXJrVmFsaWRpdHlGb3IoY29udHJvbCwgYWRkQ2xhc3MpKVxuICB9XG5cbiAgcHJpdmF0ZSBtYXJrQWxsQXNWYWxpZCAoKSB7XG4gICAgdGhpcy5mb3JtQ29udHJvbEVsUmVmcy5mb3JFYWNoKGVsUmVmID0+IHtcbiAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3MoZWxSZWYubmF0aXZlRWxlbWVudCwgdGhpcy5jbGFzc05hbWVGb3JJbnZhbGlkQ29udHJvbClcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIG5nQWZ0ZXJDb250ZW50SW5pdCAoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuc2luRGlyZWN0aXZlcyA9PSBudWxsKSB7XG4gICAgICAvLyBUaGlzIGZvcm0gZG9lcyBub3QgaGF2ZSBhbnkgc2luc1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgdGhpcy5mb3JtQ29udHJvbHMgPSByeC56aXAoXG4gICAgICB0aGlzLmZvcm1Db250cm9sTmFtZXMuY2hhbmdlcy5waXBlKHJ4b3Auc3RhcnRXaXRoKHRoaXMuZm9ybUNvbnRyb2xOYW1lcykpLFxuICAgICAgdGhpcy5mb3JtQ29udHJvbEVsUmVmcy5jaGFuZ2VzLnBpcGUocnhvcC5zdGFydFdpdGgodGhpcy5mb3JtQ29udHJvbEVsUmVmcykpLFxuICAgICkucGlwZShcbiAgICAgIHJ4b3AubWFwKChbbmFtZSwgZWxSZWZdKSA9PiAoe25hbWUsIGVsUmVmfSkpLFxuICAgIClcblxuICAgIGNvbnN0IHZpc2libGVTaW5zJDogcnguT2JzZXJ2YWJsZTxBYnN0cmFjdENvbnRyb2xbXT4gPSB0aGlzLnNpbkRpcmVjdGl2ZXMuY2hhbmdlcy5waXBlKFxuICAgICAgcnhvcC5zdGFydFdpdGgodGhpcy5zaW5EaXJlY3RpdmVzKSxcbiAgICAgIHJ4b3AubWFwKChsaXN0OiBRdWVyeUxpc3Q8U2luRGlyZWN0aXZlPikgPT4gbGlzdC50b0FycmF5KCkpLFxuICAgICAgcnhvcC5zd2l0Y2hNYXAoKHNpbnM6IFNpbkRpcmVjdGl2ZVtdKSA9PlxuICAgICAgICByeC5jb21iaW5lTGF0ZXN0KHNpbnMubWFwKHNpbiA9PiBzaW4udmlzaWJsZSQpKSksXG4gICAgICByeG9wLm1hcCgoY29udHJvbHM6IEFic3RyYWN0Q29udHJvbFtdKSA9PiBjb250cm9scy5maWx0ZXIoY29udHJvbCA9PiBjb250cm9sICE9IG51bGwpKSxcbiAgICApXG5cbiAgICB0aGlzLmZvcm1Db250cm9scy5waXBlKFxuICAgICAgcnhvcC53aXRoTGF0ZXN0RnJvbSh0aGlzLnNpbkRpcmVjdGl2ZXMuY2hhbmdlcy5waXBlKHJ4b3Auc3RhcnRXaXRoKHRoaXMuc2luRGlyZWN0aXZlcykpLCAoZmMsIHMpID0+IHMpLFxuICAgICAgcnhvcC5tYXAoKGxpc3Q6IFF1ZXJ5TGlzdDxTaW5EaXJlY3RpdmU+KSA9PiBsaXN0LnRvQXJyYXkoKS5tYXAoc2luID0+IHNpbi52aXNpYmxlJC5nZXRWYWx1ZSgpKSksXG4gICAgICByeG9wLm1hcCgoY29udHJvbHM6IEFic3RyYWN0Q29udHJvbFtdKSA9PiBjb250cm9scy5maWx0ZXIoY29udHJvbCA9PiBjb250cm9sICE9IG51bGwpKSxcbiAgICAgIHJ4b3Aud2l0aExhdGVzdEZyb20odmlzaWJsZVNpbnMkLCAoXywgc2lucykgPT4gc2lucyksXG4gICAgKVxuICAgICAgLnN1YnNjcmliZSgoY29udHJvbHM6IEFic3RyYWN0Q29udHJvbFtdKSA9PiB7XG4gICAgICAgIC8vIFdoZW4gZm9ybSBjb250cm9scyBvbiB0aGUgcGFnZSBjaGFuZ2UsIHdlIGdyYWIgdGhlIGxhc3QgaW5mbyBhYm91dFxuICAgICAgICAvLyB2aXNpYmxlIHNpbnMgYW5kIHVzZSB0aGF0LiBXZSBoYXZlIHRvIGJlIGRlc3RydWN0aXZlIGhlcmVcbiAgICAgICAgdGhpcy5tYXJrQWxsQXNWYWxpZCgpXG4gICAgICAgIHRoaXMubWFya1ZhbGlkaXR5Rm9yQWxsKGNvbnRyb2xzLCB0cnVlKVxuICAgICAgfSlcblxuICAgIHZpc2libGVTaW5zJC5waXBlKHJ4b3AucGFpcndpc2UoKSlcbiAgICAgIC5zdWJzY3JpYmUoKFtvbGRDb250cm9scywgbmV3Q29udHJvbHNdOiBQYWlyPEFic3RyYWN0Q29udHJvbFtdPikgPT4ge1xuICAgICAgICAvLyBXZSBjYW4gY2FsY3VsYXRlIGRpZmYgaW5zdGVhZCBvZiByZW1vdmluZyBhbmQgc2V0dGluZyBldmVyeXRoaW5nLlxuICAgICAgICBjb25zdCBhZGRlZCA9IGZpbmRBZGRlZChbb2xkQ29udHJvbHMsIG5ld0NvbnRyb2xzXSlcbiAgICAgICAgY29uc3QgcmVtb3ZlZCA9IGZpbmRSZW1vdmVkKFtvbGRDb250cm9scywgbmV3Q29udHJvbHNdKVxuICAgICAgICB0aGlzLm1hcmtWYWxpZGl0eUZvckFsbChhZGRlZCwgdHJ1ZSlcbiAgICAgICAgdGhpcy5tYXJrVmFsaWRpdHlGb3JBbGwocmVtb3ZlZCwgZmFsc2UpXG4gICAgICB9KVxuICB9XG5cbiAgcHVibGljIG5nT25EZXN0cm95ICgpIHtcbiAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKVxuICB9XG5cbn1cbiJdfQ==